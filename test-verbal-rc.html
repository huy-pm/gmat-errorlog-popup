<!DOCTYPE html>
<html>
<head>
    <title>GMAT Verbal RC Scraping - Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { margin-bottom: 30px; padding: 20px; border: 1px solid #ccc; }
        .test-case h2 { color: #333; }
        button { padding: 10px 15px; margin: 5px; background-color: #2196F3; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0b7dda; }
        textarea { width: 100%; height: 300px; font-family: monospace; }
        #results { margin-top: 20px; padding: 15px; background-color: #f9f9f9; }
    </style>
</head>
<body>
    <h1>GMAT Verbal RC Scraping - Test</h1>
    <p>Enter HTML content in the text area below and click "Load Content" to display it. Then click "Run RC Scraper" to test the gmatclub-verbal-rc-scraping.js script.</p>
    
    <div class="test-case">
        <h2>RC Content Input</h2>
        <textarea id="htmlInput" placeholder="Paste HTML content here..."></textarea>
        <br>
        <button onclick="loadContent()">Load Content</button>
        <button onclick="runRCTestCase()" style="background-color: #4CAF50;">Run RC Scraper</button>
        <div id="contentDisplay" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; min-height: 50px;">
            <!-- Content will be loaded here -->
        </div>
    </div>
    
    <script>
        // Function to load content from textarea into the display area
        function loadContent() {
            var htmlContent = document.getElementById('htmlInput').value;
            document.getElementById('contentDisplay').innerHTML = htmlContent;
        }
        
        // Function to run the gmatclub-verbal-rc-scraping.js script on the loaded content
        function runRCTestCase() {
            // Get the content display container
            var contentContainer = document.getElementById('contentDisplay');
            
            if (!contentContainer.innerHTML.trim()) {
                alert("No content loaded. Please load HTML content first.");
                return;
            }
            
            // Create a temporary wrapper to simulate the required DOM structure
            var wrapper = document.createElement('div');
            wrapper.className = 'post-wrapper first-post';
            wrapper.innerHTML = `
                <div class="post-info add-bookmark">
                    <div class="item text">
                        ${contentContainer.innerHTML}
                    </div>
                </div>
            `;
            
            // Run the RC scraping logic (updated version of gmatclub-verbal-rc-scraping.js)
            try {
                // Find the main item container
                let container = wrapper.querySelector('.item.text');
                if (!container) {
                    alert('No question container found.');
                    return;
                }
                
                let clone = container.cloneNode(true);
                
                // Remove unwanted blocks
                clone.querySelectorAll('.twoRowsBlock, .post_signature, .spoiler').forEach(el => el.remove());
                
                // Convert the clone to HTML string for easier manipulation
                let htmlContent = clone.innerHTML;
                
                // Find bbcodeBoxOut element
                let bbcodeBoxOut = clone.querySelector('.bbcodeBoxOut');
                if (!bbcodeBoxOut) {
                    alert('No bbcodeBoxOut found.');
                    return;
                }
                
                // Step 1: Locate the passage content
                // Find the first bbcodeBoxIn within bbcodeBoxOut
                let bbcodeBoxIns = bbcodeBoxOut.querySelectorAll('.bbcodeBoxIn');
                if (bbcodeBoxIns.length < 1) {
                    alert('No bbcodeBoxIn elements found.');
                    return;
                }
                
                let passageBox = bbcodeBoxIns[0];
                let passageHTML = passageBox.innerHTML;
                
                // Process passage content
                // Convert <br> tags to newlines
                passageHTML = passageHTML.replace(/<br\s*\/?>/gi, '\n');
                
                // Find <span> tags and enclose their content with ** markers
                passageHTML = passageHTML.replace(/<span[^>]*>(.*?)<\/span>/gi, '**$1**');
                
                // Clean up other HTML tags but preserve the marked content
                let passageText = passageHTML.replace(/<[^>]*>/g, '');
                
                // Step 2: Locate and extract questions and answers
                let questions = [];
                
                if (bbcodeBoxIns.length >= 2) {
                    let questionsBox = bbcodeBoxIns[1];
                    let questionWrappers = questionsBox.querySelectorAll('.question_wrapper');
                    
                    questionWrappers.forEach((wrapper, index) => {
                        try {
                            // Clone the wrapper to avoid modifying the original
                            let wrapperClone = wrapper.cloneNode(true);
                            
                            // Find question text in <span> tags with style="font-weight: bold"
                            let questionSpan = wrapperClone.querySelector('span[style*="font-weight: bold"]');
                            let questionText = '';
                            
                            if (questionSpan) {
                                questionText = questionSpan.textContent.trim();
                                // Remove the question number prefix (e.g., "1. ")
                                questionText = questionText.replace(/^\d+\.\s*/, '');
                            } else {
                                // Fallback: try to get text content
                                questionText = wrapperClone.textContent.trim().split('\n')[0] || '';
                                // Remove the question number prefix if present
                                questionText = questionText.replace(/^\d+\.\s*/, '');
                            }
                            
                            // Find answer choices by parsing the content after the question
                            let choices = {};
                            
                            // Get the HTML content of the wrapper
                            let wrapperHTML = wrapper.innerHTML;
                            
                            // Extract content after the question span
                            let choicesHTML = '';
                            if (questionSpan && questionSpan.outerHTML) {
                                let spanEndIndex = wrapperHTML.indexOf(questionSpan.outerHTML) + questionSpan.outerHTML.length;
                                choicesHTML = wrapperHTML.substring(spanEndIndex);
                            } else {
                                // Fallback to all content after removing the first span if it exists
                                choicesHTML = wrapperHTML;
                                if (questionSpan && questionSpan.outerHTML) {
                                    choicesHTML = choicesHTML.replace(questionSpan.outerHTML, '');
                                }
                            }
                            
                            // Parse answer choices from the HTML
                            // Convert <br> tags to newlines for easier parsing
                            choicesHTML = choicesHTML.replace(/<br\s*\/?>/gi, '\n');
                            // Remove all other HTML tags
                            let choicesText = choicesHTML.replace(/<[^>]*>/g, '');
                            
                            // Split by newlines and parse each line
                            let lines = choicesText.split('\n');
                            
                            lines.forEach(line => {
                                let cleanLine = line.trim();
                                if (cleanLine) {
                                    // Check if this line starts with a letter and period/dot
                                    let choiceMatch = cleanLine.match(/^([A-Ea-e])[.)]\s*(.*)/);
                                    if (choiceMatch) {
                                        let letter = choiceMatch[1].toUpperCase();
                                        let text = choiceMatch[2].trim();
                                        if (text) {
                                            choices[letter] = text;
                                        }
                                    }
                                }
                            });
                            
                            // Only add question if we have text
                            if (questionText) {
                                questions.push({
                                    question_text: questionText,
                                    choices: choices
                                });
                            }
                        } catch (e) {
                            console.error('Error processing question wrapper ' + index + ':', e);
                        }
                    });
                }
                
                // Step 3: Compile and format the final output
                let outputData = {
                    passage: passageText,
                    questions: questions
                };
                
                // Create popup window
                var popup = window.open("", "RC Extracted Data", "width=800,height=700,scrollbars=yes");
                popup.document.write(
                    '<html>' +
                    '<head>' +
                        '<title>RC Extracted Data</title>' +
                        '<style>' +
                            'body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }' +
                            'h2 { color: #333; border-bottom: 2px solid #333; padding-bottom: 5px; }' +
                            'h3 { color: #555; margin-top: 20px; }' +
                            'pre { background: #f4f4f4; padding: 15px; border-left: 4px solid #3498db; white-space: pre-wrap; word-wrap: break-word; }' +
                            '.section { margin-bottom: 30px; }' +
                            '.question { margin-bottom: 20px; }' +
                            'ul { margin-top: 5px; }' +
                            'li { margin-bottom: 5px; }' +
                        '</style>' +
                    '</head>' +
                    '<body>' +
                        '<div class="section">' +
                            '<h2>Passage</h2>' +
                            '<pre>' + passageText.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<span style="background-color: yellow;">$1</span>') + '</pre>' +
                        '</div>' +
                        '<div class="section">' +
                            '<h2>Questions</h2>' +
                            '<div>' +
                            (questions.length > 0 ? 
                                questions.map((q, index) => 
                                    '<div class="question">' +
                                        '<h3>Question ' + (index + 1) + '</h3>' +
                                        '<p><strong>' + q.question_text + '</strong></p>' +
                                        Object.keys(q.choices).map(letter => 
                                            '<div><strong>' + letter + '.</strong> ' + q.choices[letter] + '</div>'
                                        ).join('') +
                                    '</div>'
                                ).join('') : '<p>No questions found.</p>') +
                            '</div>' +
                        '</div>' +
                    '</body>' +
                    '</html>'
                );
                
            } catch (error) {
                alert("Error occurred: " + error.message);
            }
        }
    </script>
</body>
</html>